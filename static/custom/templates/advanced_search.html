{% extends "templates/core/layout.html" %}

{% block title %}
    {# Personnalisez ici le titre de la page (celui qui est affiché dans l'onglet du navigateur) #}
    Recherche avancée
{% endblock %}

{% block metaTags %}
    {# Ajoutez ici les balises méta utilisées pour le SEO #}
{% endblock %}

{% block additionalHeaderAssets %}
    {# Ajoutez ici les assets complémentaires qui seront dans le bloc <head></head> #}
    <script src="{{ url_for('static', filename='lib/leaflet/leafletMarkerCluster.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet/leafletMarkerCluster.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet/leafletMarkerCluster.Default.css') }}"/>

    <!-- DataTable -->
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/datatables/datatables.min.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/datatables/dataTables.bootstrap4.min.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/listEspeces.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icones.css') }}"/>
    <!-- development version, includes helpful console warnings -->
    <script src="//cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.10.2/underscore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-bootstrap-typeahead@0.2.6/dist/VueBootstrapTypeahead.umd.min.js"></script>
    <!-- production version, optimized for size and speed -->
    {#<script src="https://cdn.jsdelivr.net/npm/vue"></script>#}
    <style>
        .vbt-autcomplete-list {
            max-height: 350px;
            overflow-y: auto;
            padding-top: 5px;
            position: absolute;
            z-index: 999;
        }
    </style>
{% endblock %}



{% block additionalFooterAssets %}
    {# Ajoutez ici les assets complémentaires qui seront en bas de page #}
    <script src="{{ url_for('static', filename='custom/maps-custom.js') }}"></script>
    <script src="{{ url_for('static', filename='mapGenerator.js') }}"></script>
    <script>
        var url_limit_territory = "{{url_for('static', filename='custom/territoire.json') }}";

        var map = generateMap();

        var legend = L.control({position: "bottomright"});

        $("#loaderSpinner").hide();

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        Colors = {};
Colors.names = {
    aqua: "#00ffff",
    azure: "#f0ffff",
    beige: "#f5f5dc",
    black: "#000000",
    blue: "#0000ff",
    brown: "#a52a2a",
    cyan: "#00ffff",
    darkblue: "#00008b",
    darkcyan: "#008b8b",
    darkgrey: "#a9a9a9",
    darkgreen: "#006400",
    darkkhaki: "#bdb76b",
    darkmagenta: "#8b008b",
    darkolivegreen: "#556b2f",
    darkorange: "#ff8c00",
    darkorchid: "#9932cc",
    darkred: "#8b0000",
    darksalmon: "#e9967a",
    darkviolet: "#9400d3",
    fuchsia: "#ff00ff",
    gold: "#ffd700",
    green: "#008000",
    indigo: "#4b0082",
    khaki: "#f0e68c",
    lightblue: "#add8e6",
    lightcyan: "#e0ffff",
    lightgreen: "#90ee90",
    lightgrey: "#d3d3d3",
    lightpink: "#ffb6c1",
    lightyellow: "#ffffe0",
    lime: "#00ff00",
    magenta: "#ff00ff",
    maroon: "#800000",
    navy: "#000080",
    olive: "#808000",
    orange: "#ffa500",
    pink: "#ffc0cb",
    purple: "#800080",
    violet: "#800080",
    red: "#ff0000",
    silver: "#c0c0c0",
    white: "#ffffff",
    yellow: "#ffff00"
};

Colors.random = function() {
    var result;
    var count = 0;
    for (var prop in this.names)
        if (Math.random() < 1/++count)
           result = prop;
    return result;
};

        function displayObsTaxonMaille(cd_ref) {
        }

        var radius = 2;

        var geojsonMarkerOptions = {
            weight: 2,
            opacity: 1,
            fillOpacity: 0
        };

        var typeData = 'maille';

        var polygonLayerToCentroid = function (geoJson) {
            geoJson;
            if (geoJson.features) {
                var features = geoJson.features;
                for (var i = 0; i < geoJson.features.length; i++) {
                    var feature = geoJson.features[i];
                    var centroid = L.polygon(feature.geometry.coordinates).getBounds().getCenter();
                    geoJson.features[i].geometry = {type: 'Point', coordinates: [centroid.lat, centroid.lng]};
                }
            }
        };
        var customStyle = [{color: '#33cc33', radius: 1}, {color: '#3399ff', radius: 3}, {color: '#ff0000', radius: 5}];

        var currentLayer;
        var layerGroup = L.featureGroup();
        layerGroup.addTo(map);

        const taxaApiUrl = '/api/searchTaxon?search=:query';

        var advancedSearch = new Vue({
            el: '#advancedSearch',
            components: {
                VueBootstrapTypeahead
            },
            delimiters: ['[[', ']]'],
            data: {
                taxa: [],
                taxaSearch: '',
                selectedTaxa: null,
                layers: [],
                items: []
                {#items: []#}
            },
            methods: {
                removeElement: function (index) {
                    this.items.splice(index, 1);
                    layerGroup.removeLayer(layerGroup.getLayers()[index]);
                },
                async getTaxa(query) {
                    const res = await fetch(taxaApiUrl.replace(':query', query) + '&limit=20');
                    const suggestions = await res.json();
                    console.log(suggestions);
                    this.taxa = suggestions;
                },
                addDatas: function (list) {
                    $("#loaderSpinner").show();
                    var arrayLength = list.length;
                    var layer = [];
                    for (var i = 0; i < arrayLength; i++) {
                        var layerCustomStyle = customStyle[i];
                        console.log(layerCustomStyle);
                        $.ajax({
                            url:
                                configuration.URL_APPLICATION +
                                "/api/observationsMailleAndPoint/" + list[i].cd_nom,
                            dataType: "json",
                            beforeSend: function () {
                                $("#loaderSpinner").show();
                            }
                        }).done(function (observations) {
                            // $("#loadingGif").hide();
                            {#map.removeLayer(currentLayer);#}
                            var geoJsonDatas = observations['maille'];
                            console.log('obs', geoJsonDatas);
                            polygonLayerToCentroid(geoJsonDatas);
                            var color = getRandomColor();

                            layer[i] = L.geoJSON(geoJsonDatas, {
                                pointToLayer: function (feature, latlng) {
                                    return new L.circleMarker(latlng, geojsonMarkerOptions(layerCustomStyle));
                                }
                            });
                            layer[i].addTo(map);
                            if (geoJsonDatas.features.length > 0) {
                                map.fitBounds(layer[i].getBounds());
                            }

                        });
                        displayObsTaxonMaille(list[i]);
                    }
                    $("#loaderSpinner").hide();

                },
                addMapDatas: function (cd_nom) {
                    $("#loaderSpinner").show();
                    $.ajax({
                        url:
                            configuration.URL_APPLICATION +
                            "/api/observationsMailleAndPoint/" + cd_nom,
                        dataType: "json",
                        beforeSend: function () {
                            $("#loaderSpinner").show();
                        }
                    }).done(function (observations) {
                        var geoJsonDatas = observations[typeData];
                        console.log('obs', geoJsonDatas);
                        if (typeData === 'maille') {
                            polygonLayerToCentroid(geoJsonDatas);
                        }
                        //var color = getRandomColor();
                        var color=Colors.random();

                        var layer = L.geoJSON(geoJsonDatas, {
                            style: function (feature) {
                                return {color: color, radius: radius};
                            },
                            pointToLayer: function (feature, latlng) {
                                return L.circleMarker(latlng, geojsonMarkerOptions);
                            }
                        });
                        radius = radius + 2;
                        layerGroup.addLayer(layer);
                        console.log('layerGroup', layerGroup.getLayers());
                        map.fitBounds(layerGroup.getBounds());
                    });
                    $("#loaderSpinner").hide();
                },
           getTaxaImage: function (cd_nom) {

                }
            },
            watch: {
                taxaSearch: _.debounce(function (qs) {
                    this.getTaxa(qs)
                }, 500),
                selectedTaxa: function () {
                    var self = this;
                    console.log('selectedTaxa', this.selectedTaxa);
                    fetch('https://geonature.cbiodiv.org/taxhub/api/taxref/' + this.selectedTaxa.value)
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (jsonResp) {
                            var newItem = {
                                cd_nom: jsonResp.cd_nom,
                                nom_vern: jsonResp.nom_vern,
                                nom_sci: jsonResp.nom_complet
                            };

                            self.items.push(newItem);
                            self.addMapDatas(newItem.cd_nom);
                        });
                }
            },
            mounted() {
                {#this.addDatas(this.items);#}
            }
        })


    </script>
{% endblock %}


{% block content %}
    {# Ajoutez ici coeur de la page #}
    <div class="row h-100 flex-grow-1 p-0 m-0 border-bottom">
        <div id="advancedSearch" class="col-12 col-md-3 d-flex flex-column m-0 p-0">
            <div class="bg-light border-bottom border-right p-2">
                <div class="text-center">
                    <h4><b>Recherche avancée</b></h4>
                    <div class="input-group w-100">
                        <vue-bootstrap-typeahead
                                :data="taxa"
                                v-model="taxaSearch"
                                input-class="form-control w-100"
                                :serializer="s => s.label"
                                placeholder="Recherchez un taxon"
                                @hit="selectedTaxa = $event"
                        >
                            <template slot="suggestion" slot-scope="{data, htmlText}">
                                <span v-html="data.label"></span>
                            </template>
                        </vue-bootstrap-typeahead>
                    </div>
                    <div v-if="items.length > 3" class="text-danger">
                        <i class="fa fa-info-circle fa-fw"></i> Vous ne pouvez ajouter plus de 3 taxons
                    </div>
                </div>
            </div>
            <div id="list" class="bg-white flex-grow-1">
                <ul class="list-unstyled">
                    <li v-for="(item, key)  in items" :key="key" class="media border-bottom px-0 py-0">
                        <img class="mr-3" src="https://via.placeholder.com/80" alt="Generic placeholder image">
                        <div class="media-body p-2">
                            <span class="float-right"><span href="#" v-on:click="removeElement(key)"
                                                            class="badge badge-danger">X</span></span>
                            <h5 class="mt-0 mb-1">[[item.nom_vern]]</h5>
                            <span class="float-right">
                    <a class="badge badge-primary" :href="'/espece/'+item.cd_nom" data-toggle="tooltip"
                       title="Consulter la fiche espèce"
                       data-placement="left">
                        <i class="fas fa-list fa-fw"></i> Fiche espèce</i>
                    </a>
                            </span>
                            <p class="mt-0 mb-1 text-info">[[item.nom_sci]]</p>

                        </div>
                    </li>
                </ul>
            </div>

        </div>
        <div class="col-12 col-md-9 d-flex flex-column m-0 p-0">
            <div class="d-flex align-content-stretch bg-warning flex-grow-1">
                <div class="d-flex flex-grow-1">
                    <div id="map" style="height: unset;flex:1;"></div>
                    {% include 'templates/core/loaderSpinner.html' %}
                </div>
            </div>
        </div>
    </div>

    {# Ajoutez ici coeur de la page #}

{% endblock %}
